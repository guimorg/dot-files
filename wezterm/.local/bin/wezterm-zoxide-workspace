#!/usr/bin/env bash
set -euo pipefail

DIR=$(
  (
    zoxide query -l

    fd -H -t d '^\.git$' "$HOME/projects" -d 6 \
      | xargs -I{} dirname "{}"
  ) \
  | awk '!seen[$0]++' \
  | fzf --prompt="repo/workspace> "
)
[ -z "${DIR:-}" ] && exit 0

GIT_ROOT="$(git -C "$DIR" rev-parse --show-toplevel 2>/dev/null || true)"
if [ -n "$GIT_ROOT" ]; then
  DIR="$GIT_ROOT"
fi

WORKSPACE="$(basename "$DIR")"
CWD="$DIR"

wezterm cli switch-workspace "$WORKSPACE" >/dev/null 2>&1 || true

EXISTING_PANE="$(
  wezterm cli list --format json \
  | python3 - <<'PY'
import json, sys
ws = sys.argv[1]
items = json.load(sys.stdin)
for it in items:
    if it.get("workspace") == ws:
        print(it.get("pane_id"))
        break
PY
  "$WORKSPACE"
)"

if [ -n "${EXISTING_PANE:-}" ]; then
  wezterm cli activate-pane --pane-id "$EXISTING_PANE"
else
  wezterm cli spawn --cwd "$CWD"
fi
